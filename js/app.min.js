const API_BASE_URL="https://flow-gz1r.onrender.com";let stripe;if(typeof Stripe!=="undefined"){stripe=Stripe("pk_live_51Ra4RJG06NHrwsY9lqejmXiGn8DAGzwlrqTuarPZzIb3p1yIPchUaPGAXuKe7yJD73UCvQ3ydKzoclwRi0DiIrbP00xbXj54td")}else{console.warn("Stripe.js not loaded. Stripe functionalities will not work on this page.")}function showModalMessage(message,isError=false){const modalOverlay=document.getElementById("message-modal-overlay");const modalMessage=document.getElementById("modal-message-text");const modalCloseButton=document.getElementById("modal-close-button");if(modalOverlay&&modalMessage&&modalCloseButton){modalMessage.textContent=message;modalMessage.style.color=isError?"#ff8a80":"var(--text-light)";modalOverlay.style.display="flex";modalOverlay.style.zIndex="1000";modalCloseButton.onclick=()=>{modalOverlay.style.display="none"};modalOverlay.onclick=event=>{if(event.target===modalOverlay){modalOverlay.style.display="none"}}}else{console.error("Modal elements not found for showModalMessage. Message:",message);if(isError){console.error(`ERROR: ${message}`)}else{console.log(`MESSAGE: ${message}`)}}}function showConfirmModal(message,confirmButtonText="Confirm"){return new Promise(resolve=>{const confirmModalOverlay=document.getElementById("confirm-modal-overlay");const confirmModalMessage=document.getElementById("confirm-modal-message");const modalConfirmButton=document.getElementById("modal-confirm");const modalCancelButton=document.getElementById("modal-cancel");if(!confirmModalOverlay||!confirmModalMessage||!modalConfirmButton||!modalCancelButton){console.error("Confirmation modal elements not found. Falling back to native confirm.");resolve(window.confirm(message));return}confirmModalMessage.innerHTML=message;modalConfirmButton.textContent=confirmButtonText;confirmModalOverlay.style.display="flex";const handleConfirm=()=>{confirmModalOverlay.style.display="none";modalConfirmButton.removeEventListener("click",handleConfirm);modalCancelButton.removeEventListener("click",handleCancel);resolve(true)};const handleCancel=()=>{confirmModalOverlay.style.display="none";modalConfirmButton.removeEventListener("click",handleConfirm);modalCancelButton.removeEventListener("click",handleCancel);resolve(false)};modalConfirmButton.addEventListener("click",handleConfirm);modalCancelButton.addEventListener("click",handleCancel);confirmModalOverlay.onclick=event=>{if(event.target===confirmModalOverlay){handleCancel()}}})}function setupSettingsDropdown(){const settingsButton=document.getElementById("settings-button");const settingsDropdown=document.getElementById("settings-dropdown");const logoutButton=document.getElementById("logout-button");const upgradePlanLink=document.getElementById("upgrade-plan-link");if(settingsButton&&settingsDropdown){settingsButton.addEventListener("click",async event=>{event.stopPropagation();settingsDropdown.style.display=settingsDropdown.style.display==="block"?"none":"block";if(settingsDropdown.style.display==="block"&&upgradePlanLink){if(localStorage.getItem("authToken")){try{const profile=await apiRequest("GET","/profile");if(profile&&profile.plan_id==="free"){upgradePlanLink.style.display="block"}else{upgradePlanLink.style.display="none"}}catch(error){console.error("Error fetching profile for upgrade link:",error);upgradePlanLink.style.display="none"}}else{upgradePlanLink.style.display="none"}}});document.addEventListener("click",event=>{if(!settingsButton.contains(event.target)&&!settingsDropdown.contains(event.target)){settingsDropdown.style.display="none"}})}if(logoutButton){logoutButton.addEventListener("click",()=>{localStorage.removeItem("authToken");localStorage.removeItem("userRole");window.location.href="login.html"})}}async function apiRequest(method,path,body=null,isFormData=false,onProgress=null){const token=localStorage.getItem("authToken");const endpoint=`${API_BASE_URL}${path}`;if(isFormData){return new Promise((resolve,reject)=>{const xhr=new XMLHttpRequest;xhr.open(method,endpoint);if(token){xhr.setRequestHeader("Authorization",`Bearer ${token}`)}if(onProgress&&xhr.upload){xhr.upload.addEventListener("progress",onProgress)}xhr.onload=function(){if(xhr.status>=200&&xhr.status<300){if(xhr.status===204||xhr.status===200&&xhr.responseText.length===0){resolve({})}else{try{const responseData=JSON.parse(xhr.responseText);resolve(responseData)}catch(e){console.warn("API response was not JSON, resolving with success status:",xhr.responseText);resolve({message:"Operation successful",rawResponse:xhr.responseText})}}}else if(xhr.status===401||xhr.status===403){localStorage.removeItem("authToken");localStorage.removeItem("userRole");window.location.href="login.html?sessionExpired=true";reject(new Error("Authentication token missing or invalid."))}else{try{const errorData=JSON.parse(xhr.responseText);reject(new Error(errorData.error||`HTTP error! Status: ${xhr.status}`))}catch(e){reject(new Error(`HTTP error! Status: ${xhr.status} - ${xhr.statusText||"Unknown Error"}`))}}};xhr.onerror=function(){reject(new Error("Network error or request failed. Please check your internet connection."))};xhr.send(body)})}else{const options={method:method,headers:{"Content-Type":"application/json"}};if(token){options.headers["Authorization"]=`Bearer ${token}`}if(body){options.body=JSON.stringify(body)}const response=await fetch(endpoint,options);if(response.status===401||response.status===403){localStorage.removeItem("authToken");localStorage.removeItem("userRole");window.location.href="login.html?sessionExpired=true";throw new Error("Authentication token missing or invalid.")}if(!response.ok){const errorData=await response.json();throw new Error(errorData.error||"Something went wrong")}if(response.status===204||response.status===200&&response.headers.get("content-length")==="0"){return null}return response.json()}}function handleLoginPage(){const loginForm=document.getElementById("login-form");if(!loginForm){return}const urlParams=new URLSearchParams(window.location.search);if(urlParams.has("sessionExpired")&&urlParams.get("sessionExpired")==="true"){const errorMessageDiv=document.getElementById("error-message");if(errorMessageDiv){errorMessageDiv.textContent="Your session has expired or is invalid. Please log in again.";errorMessageDiv.classList.add("visible");errorMessageDiv.setAttribute("aria-hidden","false")}urlParams.delete("sessionExpired");window.history.replaceState({},document.title,window.location.pathname+(urlParams.toString()?"?"+urlParams.toString():""))}loginForm.addEventListener("submit",async e=>{e.preventDefault();const emailInput=document.getElementById("email");const passwordInput=document.getElementById("password");const email=emailInput.value.trim();const password=passwordInput.value;const errorMessage=document.getElementById("error-message");if(errorMessage){errorMessage.textContent="";errorMessage.classList.remove("visible");errorMessage.setAttribute("aria-hidden","true")}if(!email||!password){if(errorMessage){errorMessage.textContent="Email and password are required.";errorMessage.classList.add("visible");errorMessage.setAttribute("aria-hidden","false")}return}const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!emailRegex.test(email)){if(errorMessage){errorMessage.textContent="Please enter a valid email address.";errorMessage.classList.add("visible");errorMessage.setAttribute("aria-hidden","false")}return}if(password.length<6){if(errorMessage){errorMessage.textContent="Password must be at least 6 characters long.";errorMessage.classList.add("visible");errorMessage.setAttribute("aria-hidden","false")}return}try{const data=await apiRequest("POST","/login",{email:email,password:password});localStorage.setItem("authToken",data.token);localStorage.setItem("userRole",data.role);if(data.role==="super_admin"||data.role==="location_admin"){window.location.href="suite-hub.html"}else{window.location.href="new-hire-view.html"}}catch(error){console.error("Login API error:",error);if(errorMessage){errorMessage.textContent=`Login Failed: ${error.message}`;errorMessage.classList.add("visible");errorMessage.setAttribute("aria-hidden","false")}showModalMessage(`Login Failed: ${error.message}`,true)}})}function handleRegisterPage(){const registerForm=document.getElementById("register-form");if(!registerForm){return}registerForm.addEventListener("submit",async e=>{e.preventDefault();const companyNameInput=document.getElementById("company-name");const fullNameInput=document.getElementById("full-name");const emailInput=document.getElementById("email");const passwordInput=document.getElementById("password");const errorMessage=document.getElementById("error-message");const company_name=companyNameInput.value.trim();const full_name=fullNameInput.value.trim();const email=emailInput.value.trim();const password=passwordInput.value;errorMessage.textContent="";errorMessage.classList.remove("visible");errorMessage.setAttribute("aria-hidden","true");const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!company_name||!full_name||!email||!password||password.length<6||!emailRegex.test(email)){errorMessage.textContent="Please fill all fields correctly. Password must be at least 6 characters and email valid.";errorMessage.classList.add("visible");errorMessage.setAttribute("aria-hidden","false");return}try{const data=await apiRequest("POST","/register",{company_name:company_name,full_name:full_name,email:email,password:password});showModalMessage("Account created successfully! Please log in.",false);companyNameInput.value="";fullNameInput.value="";emailInput.value="";passwordInput.value="";setTimeout(()=>{window.location.href="login.html"},2e3)}catch(error){console.error("Registration API error:",error);if(errorMessage){errorMessage.textContent=`Registration Failed: ${error.message}`;errorMessage.classList.add("visible");errorMessage.setAttribute("aria-hidden","false")}showModalMessage(`Registration Failed: ${error.message}`,true)}})}function handleSuiteHubPage(){if(!localStorage.getItem("authToken")){window.location.href="login.html";return}const urlParams=new URLSearchParams(window.location.search);const paymentStatus=urlParams.get("payment");const sessionId=urlParams.get("session_id");if(paymentStatus==="success"){showModalMessage("Payment successful! Your subscription has been updated.",false);history.replaceState({},document.title,window.location.pathname)}else if(paymentStatus==="cancelled"){showModalMessage("Payment cancelled. You can try again or choose another plan.",true);history.replaceState({},document.title,window.location.pathname)}}function handleAccountPage(){if(!localStorage.getItem("authToken")){window.location.href="login.html";return}const displayProfileName=document.getElementById("display-profile-name");const displayProfileEmail=document.getElementById("display-profile-email");const profileNameInput=document.getElementById("profile-name");const profileEmailInput=document.getElementById("profile-email");const updateProfileForm=document.getElementById("update-profile-form");const currentPasswordInput=document.getElementById("current-password");const newPasswordInput=document.getElementById("new-password");async function loadProfileInfo(){try{const profile=await apiRequest("GET","/profile");if(displayProfileName)displayProfileName.textContent=profile.fullName||"N/A";if(displayProfileEmail)displayProfileEmail.textContent=profile.email||"N/A";if(profileNameInput)profileNameInput.value=profile.fullName||"";if(profileEmailInput)profileEmailInput.value=profile.email||""}catch(error){console.error("Error loading profile info:",error);showModalMessage(`Failed to load profile: ${error.message}`,true)}}if(updateProfileForm){updateProfileForm.addEventListener("submit",async e=>{e.preventDefault();const fullName=profileNameInput?profileNameInput.value:"";const email=profileEmailInput?profileEmailInput.value:"";const currentPassword=currentPasswordInput?currentPasswordInput.value:"";const newPassword=newPasswordInput?newPasswordInput.value:"";const updatePayload={fullName:fullName,email:email};if(currentPassword&&newPassword){updatePayload.currentPassword=currentPassword;updatePayload.newPassword=newPassword}try{const result=await apiRequest("PUT","/profile",updatePayload);if(result&&result.token){localStorage.setItem("authToken",result.token)}showModalMessage(result.message||"Profile updated successfully!",false);if(currentPasswordInput)currentPasswordInput.value="";if(newPasswordInput)newPasswordInput.value="";loadProfileInfo()}catch(error){console.error("Error updating profile:",error);showModalMessage(`Failed to update profile: ${error.message}`,true)}})}loadProfileInfo()}function handleAdminPage(){if(!localStorage.getItem("authToken")){window.location.href="login.html";return}const locationListDiv=document.getElementById("location-list");const userListDiv=document.getElementById("user-list");const newLocationForm=document.getElementById("new-location-form");const inviteAdminForm=document.getElementById("invite-admin-form");const inviteEmployeeForm=document.getElementById("invite-employee-form");const adminLocationSelect=document.getElementById("admin-location-select");const employeeLocationSelect=document.getElementById("employee-location-select");async function loadLocations(){if(!locationListDiv){return}locationListDiv.innerHTML="<p>Loading locations...</p>";try{const locations=await apiRequest("GET","/locations");locationListDiv.innerHTML="";if(locations.length===0){locationListDiv.innerHTML='<p style="color: var(--text-medium);">No locations created yet.</p>';if(adminLocationSelect){adminLocationSelect.innerHTML='<option value="">Select a location</option>';adminLocationSelect.disabled=true}if(employeeLocationSelect){employeeLocationSelect.innerHTML='<option value="">Select a location</option>';employeeLocationSelect.disabled=true}}else{if(adminLocationSelect)adminLocationSelect.disabled=false;if(employeeLocationSelect)employeeLocationSelect.disabled=false;locations.forEach(loc=>{const locDiv=document.createElement("div");locDiv.className="list-item";locDiv.innerHTML=`<span>${loc.location_name} - ${loc.location_address}</span>
                                        <button class="btn-delete" data-type="location" data-id="${loc.location_id}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path d="M14.5 3a1 10 0 0 1-1 1H13v9a2 10 0 0 1-2 2H5a2 10 0 0 1-2-2V4h-.5a1 10 0 0 1-1-1V2a1 10 0 0 1 1-1H6a1 10 0 0 1 1-1h2a1 10 0 0 1 1 1h3.5a1 10 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 10 0 0 0 1 1h6a1 10 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                        </button>`;locDiv.addEventListener("click",e=>{if(!e.target.closest(".btn-delete")){showModalMessage(`Location: ${loc.location_name} (ID: ${loc.location_id}) - Address: ${loc.location_address}`,false)}});locationListDiv.appendChild(locDiv)});const locationOptionsHtml=locations.map(loc=>`<option value="${loc.location_id}">${loc.location_name}</option>`).join("");if(adminLocationSelect){adminLocationSelect.innerHTML=`<option value="">Select a location</option>${locationOptionsHtml}`}if(employeeLocationSelect){employeeLocationSelect.innerHTML=`<option value="">Select a location</option>${locationOptionsHtml}`}}}catch(error){console.error("Error loading locations:",error);showModalMessage(`Failed to load locations: ${error.message}`,true)}}async function loadUsers(){if(!userListDiv)return;userListDiv.innerHTML="<p>Loading users...</p>";try{const users=await apiRequest("GET","/users");userListDiv.innerHTML="";if(users.length===0){userListDiv.innerHTML='<p style="color: var(--text-medium);">No users invited yet.</p>'}else{users.forEach(user=>{const userDiv=document.createElement("div");userDiv.className="list-item";let userInfo=`${user.full_name} - Role: ${user.role}`;if(user.location_name){userInfo+=` @ ${user.location_name}`}userDiv.innerHTML=`<span>${userInfo}</span>
                                         <button class="btn-delete" data-type="user" data-id="${user.user_id}">
                                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path d="M14.5 3a1 10 0 0 1-1 1H13v9a2 10 0 0 1-2 2H5a2 10 0 0 1-2-2V4h-.5a1 10 0 0 1-1-1V2a1 10 0 0 1 1-1H6a1 10 0 0 1 1-1h2a1 10 0 0 1 1 1h3.5a1 10 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 10 0 0 0 1 1h6a1 10 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                         </button>`;userDiv.appendChild(userDiv)})}}catch(error){console.error("Error loading users:",error);userListDiv.innerHTML=`<p style="color: #e74c3c;">Error loading users: ${error.message}</p>`}}document.body.addEventListener("click",async e=>{const targetButton=e.target.closest(".btn-delete");if(targetButton){console.log("handleAdminPage: Delete button clicked.");const id=targetButton.dataset.id;const type=targetButton.dataset.type;const confirmationMessage=`Are you sure you want to delete this ${type}? This action cannot be undone.`;const confirmed=await showConfirmModal(confirmationMessage,"Delete");if(confirmed){try{console.log(`handleAdminPage: Deleting ${type} with ID: ${id}.`);if(type==="location"){await apiRequest("DELETE",`/locations/${id}`);showModalMessage("Location deleted successfully!",false);loadLocations();loadUsers()}else if(type==="user"){await apiRequest("DELETE",`/users/${id}`);showModalMessage("User deleted successfully!",false);loadUsers()}console.log(`handleAdminPage: ${type} deleted successfully.`)}catch(error){showModalMessage(`Error deleting ${type}: ${error.message}`,true)}}}});if(newLocationForm){console.log("handleAdminPage: New location form found, attaching listener.");newLocationForm.addEventListener("submit",async e=>{e.preventDefault();console.log("handleAdminPage: New location form submitted.");const nameInput=document.getElementById("new-location-name");const addressInput=document.getElementById("new-location-address");const location_name=nameInput.value.trim();const location_address=addressInput.value.trim();try{console.log("handleAdminPage: Creating location via API.");await apiRequest("POST","/locations",{location_name:location_name,location_address:location_address});nameInput.value="";addressInput.value="";showModalMessage("Location created successfully!",false);console.log("handleAdminPage: Location created, reloading lists.");loadLocations()}catch(error){console.error("Error creating location:",error);showModalMessage(`Error creating location: ${error.message}`,true)}})}if(inviteAdminForm){console.log("handleAdminPage: Invite admin form found, attaching listener.");inviteAdminForm.addEventListener("submit",async e=>{e.preventDefault();console.log("handleAdminPage: Invite admin form submitted.");const adminName=document.getElementById("admin-name")?document.getElementById("admin-name").value.trim():"";const adminEmail=document.getElementById("admin-email")?document.getElementById("admin-email").value.trim():"";const adminPassword=document.getElementById("admin-password")?document.getElementById("admin-password").value:"";const adminLocationSelectElement=document.getElementById("admin-location-select");const adminLocationId=adminLocationSelectElement?adminLocationSelectElement.value:"";if(!adminName||!adminEmail||!adminPassword||adminPassword.length<6||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(adminEmail)){showModalMessage("Please provide a full name, valid email, and a password (min 6 chars) for the new admin.",true);return}if(!adminLocationId){showModalMessage("Please select a location to assign the admin.",true);return}try{console.log("handleAdminPage: Inviting admin via API.");await apiRequest("POST","/invite-admin",{full_name:adminName,email:adminEmail,location_id:parseInt(adminLocationId),password:adminPassword});if(document.getElementById("admin-name"))document.getElementById("admin-name").value="";if(document.getElementById("admin-email"))document.getElementById("admin-email").value="";if(document.getElementById("admin-password"))document.getElementById("admin-password").value="";if(adminLocationSelectElement)adminLocationSelectElement.value="";showModalMessage(`Admin invite sent to ${adminEmail} for selected location with the provided temporary password.`,false);console.log("handleAdminPage: Admin invited, reloading users.");loadUsers()}catch(error){console.error("Error inviting admin:",error);showModalMessage(`Failed to invite admin: ${error.message}`,true)}})}if(inviteEmployeeForm){console.log("handleAdminPage: Invite employee form found, attaching listener.");inviteEmployeeForm.addEventListener("submit",async e=>{e.preventDefault();console.log("handleAdminPage: Invite employee form submitted.");const employeeName=document.getElementById("employee-name")?document.getElementById("employee-name").value.trim():"";const employeeEmail=document.getElementById("employee-email")?document.getElementById("employee-email").value.trim():"";const employeePassword=document.getElementById("employee-password")?document.getElementById("employee-password").value:"";const employeePosition=document.getElementById("employee-position")?document.getElementById("employee-position").value.trim():"";const employeeId=document.getElementById("employee-id")?document.getElementById("employee-id").value.trim():null;const employeeLocationSelectElement=document.getElementById("employee-location-select");const employeeLocationId=employeeLocationSelectElement?employeeLocationSelectElement.value:"";if(!employeeName||!employeeEmail||!employeePassword||employeePassword.length<6||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(employeeEmail)){showModalMessage("Full name, valid email, and a password (min 6 chars) are required for employee invitation.",true);return}const locationIdToSend=employeeLocationId?parseInt(employeeLocationId):null;const employeeIdToSend=employeeId?isNaN(parseInt(employeeId))?employeeId:parseInt(employeeId):null;try{console.log("handleAdminPage: Inviting employee via API.");await apiRequest("POST","/invite-employee",{full_name:employeeName,email:employeeEmail,password:employeePassword,position:employeePosition||null,employee_id:employeeIdToSend,location_id:locationIdToSend});if(document.getElementById("employee-name"))document.getElementById("employee-name").value="";if(document.getElementById("employee-email"))document.getElementById("employee-email").value="";if(document.getElementById("employee-password"))document.getElementById("employee-password").value="";if(document.getElementById("employee-position"))document.getElementById("employee-position").value="";if(document.getElementById("employee-id"))document.getElementById("employee-id").value="";if(employeeLocationSelectElement)employeeLocationSelectElement.value="";showModalMessage(`Employee invite sent to ${employeeEmail} with the provided temporary password.`,false);console.log("handleAdminPage: Employee invited, reloading users.");loadUsers()}catch(error){console.error("Error inviting employee:",error);showModalMessage(`Failed to invite employee: ${error.message}`,true)}})}loadLocations();loadUsers()}function handlePricingPage(){console.log("handlePricingPage: Initializing pricing page logic.");const freePlanBtn=document.getElementById("free-plan-btn");const proPlanBtn=document.getElementById("pro-plan-btn");const enterprisePlanBtn=document.getElementById("enterprise-plan-btn");if(!freePlanBtn||!proPlanBtn||!enterprisePlanBtn){console.error("handlePricingPage: One or more pricing plan buttons not found. Check IDs in HTML.");return}console.log("handlePricingPage: All pricing plan buttons found.");const registerCheckoutModalOverlay=document.getElementById("register-checkout-modal-overlay");const registerCheckoutForm=document.getElementById("register-checkout-form");const regCheckoutModalTitle=document.getElementById("register-checkout-modal-title");const regCheckoutErrorMessage=document.getElementById("register-checkout-error-message");const regCheckoutCancelBtn=document.getElementById("reg-checkout-cancel-btn");let selectedPlanForRegistration=null;if(freePlanBtn){freePlanBtn.addEventListener("click",()=>{console.log("handlePricingPage: Free plan button clicked.");showModalMessage("You are currently on the Free plan. No action needed.",false)})}async function initiateStripeCheckout(planId,token){console.log(`initiateStripeCheckout: Proceeding with checkout for plan: ${planId}`);try{if(typeof stripe==="undefined"||stripe===null){console.error("Stripe object is not initialized. Cannot proceed with checkout.");showModalMessage("Payment processing is unavailable. Please refresh the page.",true);return}const response=await apiRequest("POST","/create-checkout-session",{planId:planId});const sessionId=response.sessionId;console.log("initiateStripeCheckout: Received session ID from backend:",sessionId);if(sessionId){console.log("initiateStripeCheckout: Redirecting to Stripe Checkout.");const result=await stripe.redirectToCheckout({sessionId:sessionId});if(result.error){console.error("Stripe Checkout Error:",result.error.message);showModalMessage(`Stripe Checkout Error: ${result.error.message}`,true)}}else{console.error("initiateStripeCheckout: Session ID not received from backend.");showModalMessage("Failed to create Stripe Checkout session. Please try again.",true)}}catch(error){console.error("Error initiating checkout:",error);showModalMessage(`Error initiating checkout: ${error.message}`,true)}}const handlePlanButtonClick=async event=>{console.log("handlePricingPage: Plan button clicked. Target:",event.target);const planId=event.target.dataset.planId;if(!planId){console.error("handlePricingPage: Plan ID not found on button. Check data-plan-id attribute.");showModalMessage("Plan ID not found. Cannot proceed with checkout.",true);return}selectedPlanForRegistration=planId;const authToken=localStorage.getItem("authToken");if(!authToken){console.log("handlePricingPage: No auth token found, displaying registration modal.");regCheckoutModalTitle.textContent=`Sign Up & Subscribe to ${planId.charAt(0).toUpperCase()+planId.slice(1)} Plan`;regCheckoutErrorMessage.textContent="";regCheckoutErrorMessage.classList.remove("visible");registerCheckoutModalOverlay.style.display="flex";document.getElementById("reg-co-name").value="";document.getElementById("reg-full-name").value="";document.getElementById("reg-email").value="";document.getElementById("reg-password").value="";return}console.log("handlePricingPage: Auth token found, proceeding directly with checkout.");await initiateStripeCheckout(planId,authToken)};if(proPlanBtn){proPlanBtn.addEventListener("click",handlePlanButtonClick);console.log("handlePricingPage: Attached click listener to Pro button.")}if(enterprisePlanBtn){enterprisePlanBtn.addEventListener("click",handlePlanButtonClick);console.log("handlePricingPage: Attached click listener to Enterprise button.")}if(registerCheckoutForm){registerCheckoutForm.addEventListener("submit",async e=>{e.preventDefault();console.log("Register/Checkout Form Submitted from modal.");const companyName=document.getElementById("reg-co-name").value.trim();const fullName=document.getElementById("reg-full-name").value.trim();const email=document.getElementById("reg-email").value.trim();const password=document.getElementById("reg-password").value;regCheckoutErrorMessage.textContent="";regCheckoutErrorMessage.classList.remove("visible");const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!companyName||!fullName||!email||!password||password.length<6||!emailRegex.test(email)){regCheckoutErrorMessage.textContent="Please fill all fields correctly. Password must be at least 6 characters and email valid.";regCheckoutErrorMessage.classList.add("visible");return}try{console.log("Attempting to register new user via API call.");const registerResponse=await apiRequest("POST","/register",{company_name:companyName,full_name:fullName,email:email,password:password});if(registerResponse){console.log("Registration successful. Now attempting to log in the new user to get an auth token for checkout.");const loginResponse=await apiRequest("POST","/login",{email:email,password:password});if(loginResponse&&loginResponse.token){localStorage.setItem("authToken",loginResponse.token);localStorage.setItem("userRole",loginResponse.role);registerCheckoutModalOverlay.style.display="none";showModalMessage("Account created successfully! Redirecting to payment...",false);await initiateStripeCheckout(selectedPlanForRegistration,loginResponse.token)}else{throw new Error("Failed to log in after successful registration. Please try logging in manually.")}}else{throw new Error("Registration failed unexpectedly. Please try again.")}}catch(error){console.error("Registration/Checkout process error:",error);regCheckoutErrorMessage.textContent=`Error: ${error.message}`;regCheckoutErrorMessage.classList.add("visible");showModalMessage(`Registration/Payment failed: ${error.message}`,true)}})}if(regCheckoutCancelBtn){regCheckoutCancelBtn.addEventListener("click",()=>{registerCheckoutModalOverlay.style.display="none"})}}function formatDate(date){const d=new Date(date);let month=""+(d.getMonth()+1);let day=""+d.getDate();const year=d.getFullYear();if(month.length<2)month="0"+month;if(day.length<2)day="0"+day;return[year,month,day].join("-")}function formatTime(date){const d=new Date(date);let hours=d.getHours();const minutes=d.getMinutes();const ampm=hours>=12?"PM":"AM";hours=hours%12;hours=hours?hours:12;const strMinutes=minutes<10?"0"+minutes:minutes;return`${hours}:${strMinutes} ${ampm}`}function calculateShiftPosition(startTime,endTime){const startHour=new Date(startTime).getHours();const startMinutes=new Date(startTime).getMinutes();const endHour=new Date(endTime).getHours();const endMinutes=new Date(endTime).getMinutes();const startTotalMinutes=startHour*60+startMinutes;const endTotalMinutes=endHour*60+endMinutes;const durationMinutes=endTotalMinutes-startTotalMinutes;const slotHeight=30;const top=startTotalMinutes/60*slotHeight;const height=durationMinutes/60*slotHeight;return{top:top,height:height}}function renderTimeColumn(){const timeColumn=document.getElementById("time-column");if(!timeColumn)return;timeColumn.innerHTML="";for(let i=0;i<24;i++){const timeSlot=document.createElement("div");timeSlot.className="calendar-time-slot";const hour=i%12===0?12:i%12;const ampm=i<12?"AM":"PM";timeSlot.textContent=`${hour}:00 ${ampm}`;timeColumn.appendChild(timeSlot)}}function handleSchedulingPage(){if(!localStorage.getItem("authToken")){window.location.href="login.html";return}const employeeSelect=document.getElementById("employee-select");const locationSelect=document.getElementById("location-select");const createShiftForm=document.getElementById("create-shift-form");const filterEmployeeSelect=document.getElementById("filter-employee-select");const filterLocationSelect=document.getElementById("filter-location-select");const filterStartDateInput=document.getElementById("filter-start-date");const filterEndDateInput=document.getElementById("filter-end-date");const applyFiltersBtn=document.getElementById("apply-filters-btn");const clearFiltersBtn=document.getElementById("clear-filters-btn");const calendarGrid=document.getElementById("calendar-grid");const currentWeekDisplay=document.getElementById("current-week-display");const prevWeekBtn=document.getElementById("prev-week-btn");const nextWeekBtn=document.getElementById("next-week-btn");let currentWeekStart=new Date;currentWeekStart.setDate(currentWeekStart.getDate()-currentWeekStart.getDay());currentWeekStart.setHours(0,0,0,0);renderTimeColumn();async function loadDropdowns(){try{const users=await apiRequest("GET","/users");const locations=await apiRequest("GET","/locations");const allSchedulableUsers=users.filter(user=>user.role==="employee"||user.role==="location_admin").sort((a,b)=>a.full_name.localeCompare(b.full_name));[employeeSelect,filterEmployeeSelect].forEach(selectElement=>{if(!selectElement)return;selectElement.innerHTML=`<option value="">${selectElement.id==="employee-select"?"Select Employee":"All Employees"}</option>`;allSchedulableUsers.forEach(user=>{const option=document.createElement("option");option.value=user.user_id;option.textContent=`${user.full_name} (${user.role.replace("_"," ")})`;selectElement.appendChild(option)})});[locationSelect,filterLocationSelect].forEach(selectElement=>{if(!selectElement)return;selectElement.innerHTML=`<option value="">${selectElement.id==="location-select"?"Select Location":"All Locations"}</option>`;locations.forEach(loc=>{const option=document.createElement("option");option.value=loc.location_id;option.textContent=loc.location_name;selectElement.appendChild(option)})})}catch(error){console.error("Error loading scheduling dropdowns:",error);showModalMessage(`Failed to load options: ${error.message}`,true)}}async function renderCalendar(){if(!calendarGrid)return;const existingDayHeaders=Array.from(calendarGrid.children).filter(child=>child.classList.contains("calendar-day-header")&&child.style.gridColumn!=="1");existingDayHeaders.forEach(el=>el.remove());const existingDayCells=calendarGrid.querySelectorAll(".calendar-day-cell");existingDayCells.forEach(el=>el.remove());const dayHeadersFragment=document.createDocumentFragment();const weekEnd=new Date(currentWeekStart);weekEnd.setDate(weekEnd.getDate()+6);currentWeekDisplay.textContent=`${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}`;const daysToRender=[];for(let i=0;i<7;i++){const date=new Date(currentWeekStart);date.setDate(currentWeekStart.getDate()+i);daysToRender.push(date);const dayHeader=document.createElement("div");dayHeader.className="calendar-day-header";dayHeader.style.gridColumn=`${i+2}`;dayHeader.style.gridRow="1";dayHeader.textContent=date.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});calendarGrid.appendChild(dayHeader)}const dayCells={};daysToRender.forEach((date,i)=>{const dayCell=document.createElement("div");dayCell.className="calendar-day-cell";dayCell.id=`day-cell-${formatDate(date)}`;dayCell.style.gridColumn=`${i+2}`;dayCell.style.gridRow="2 / span 24";dayCells[formatDate(date)]=dayCell;calendarGrid.appendChild(dayCell)});const filters={start_date:formatDate(currentWeekStart),end_date:formatDate(weekEnd),employee_id:filterEmployeeSelect.value||undefined,location_id:filterLocationSelect.value||undefined};if(filterStartDateInput.value)filters.start_date=filterStartDateInput.value;if(filterEndDateInput.value)filters.end_date=filterEndDateInput.value;try{const shifts=await apiRequest("GET",`/schedules?${new URLSearchParams(filters).toString()}`);console.log("Fetched shifts:",shifts);shifts.forEach(shift=>{const shiftStart=new Date(shift.start_time);const shiftEnd=new Date(shift.end_time);const shiftDate=formatDate(shiftStart);const targetCell=dayCells[shiftDate];if(targetCell){const{top,height}=calculateShiftPosition(shiftStart,shiftEnd);const shiftElement=document.createElement("div");shiftElement.className="calendar-shift";if(shiftEnd<new Date){shiftElement.classList.add("overdue")}shiftElement.style.top=`${top}px`;shiftElement.style.height=`${height}px`;shiftElement.dataset.scheduleId=shift.schedule_id;shiftElement.dataset.employeeName=shift.employee_name;shiftElement.dataset.locationName=shift.location_name;shiftElement.dataset.startTime=shift.start_time;shiftElement.dataset.endTime=shift.end_time;shiftElement.dataset.notes=shift.notes||"No notes.";shiftElement.innerHTML=`
                        <strong>${shift.employee_name}</strong><br>
                        ${formatTime(shiftStart)} - ${formatTime(shiftEnd)}
                        <span style="font-size: 0.7em;">(${shift.location_name})</span>
                    `;targetCell.appendChild(shiftElement)}})}catch(error){console.error("Error fetching schedules:",error);showModalMessage(`Failed to load schedules: ${error.message}`,true)}}if(createShiftForm){createShiftForm.addEventListener("submit",async e=>{e.preventDefault();const employeeId=employeeSelect.value;const locationId=locationSelect.value;const startTime=document.getElementById("start-time-input").value;const endTime=document.getElementById("end-time-input").value;const notes=document.getElementById("notes-input").value.trim();if(!employeeId||!locationId||!startTime||!endTime){showModalMessage("Please fill in all required fields for the new shift.",true);return}if(new Date(startTime)>=new Date(endTime)){showModalMessage("Start time must be before end time.",true);return}try{await apiRequest("POST","/schedules",{employee_id:parseInt(employeeId),location_id:parseInt(locationId),start_time:startTime,end_time:endTime,notes:notes||null});showModalMessage("Shift created successfully!",false);createShiftForm.reset();renderCalendar()}catch(error){console.error("Error creating shift:",error);showModalMessage(`Failed to create shift: ${error.message}`,true)}})}if(prevWeekBtn){prevWeekBtn.addEventListener("click",()=>{currentWeekStart.setDate(currentWeekStart.getDate()-7);renderCalendar()})}if(nextWeekBtn){nextWeekBtn.addEventListener("click",()=>{currentWeekStart.setDate(currentWeekStart.getDate()+7);renderCalendar()})}if(applyFiltersBtn){applyFiltersBtn.addEventListener("click",()=>{if(filterStartDateInput.value){currentWeekStart=new Date(filterStartDateInput.value);currentWeekStart.setDate(currentWeekStart.getDate()-currentWeekStart.getDay());currentWeekStart.setHours(0,0,0,0)}else{currentWeekStart=new Date;currentWeekStart.setDate(currentWeekStart.getDate()-currentWeekStart.getDay());currentWeekStart.setHours(0,0,0,0)}renderCalendar()})}if(clearFiltersBtn){clearFiltersBtn.addEventListener("click",()=>{filterEmployeeSelect.value="";filterLocationSelect.value="";filterStartDateInput.value="";filterEndDateInput.value="";currentWeekStart=new Date;currentWeekStart.setDate(currentWeekStart.getDate()-currentWeekStart.getDay());currentWeekStart.setHours(0,0,0,0);renderCalendar()})}if(calendarGrid){calendarGrid.addEventListener("click",async e=>{const shiftElement=e.target.closest(".calendar-shift");if(shiftElement){const scheduleId=shiftElement.dataset.scheduleId;const employeeName=shiftElement.dataset.employeeName;const locationName=shiftElement.dataset.locationName;const startTime=new Date(shiftElement.dataset.startTime);const endTime=new Date(shiftElement.dataset.endTime);const notes=shiftElement.dataset.notes;const confirmed=await showConfirmModal(`
                    <h3>Shift Details</h3>
                    <p><strong>Employee:</strong> ${employeeName}</p>
                    <p><strong>Location:</strong> ${locationName}</p>
                    <p><strong>Time:</strong> ${formatTime(startTime)} - ${formatTime(endTime)}</p>
                    <p><strong>Date:</strong> ${formatDate(startTime)}</p>
                    <p><strong>Notes:</strong> ${notes}</p>
                    <p style="margin-top:15px;">Do you want to delete this shift?</p>
                `,"Delete Shift");if(confirmed){try{await apiRequest("DELETE",`/schedules/${scheduleId}`);showModalMessage("Shift deleted successfully!",false);renderCalendar()}catch(error){console.error("Error deleting shift:",error);showModalMessage(`Failed to delete shift: ${error.message}`,true)}}}})}loadDropdowns();renderCalendar()}function handleHiringPage(){if(!localStorage.getItem("authToken")){window.location.href="login.html";return}console.log("Hiring page logic goes here. (Implementation pending)")}function handleSalesAnalyticsPage(){if(!localStorage.getItem("authToken")){window.location.href="login.html";return}console.log("Sales Analytics page logic goes here. (Implementation pending)")}function handleDashboardPage(){if(!localStorage.getItem("authToken")){window.location.href="login.html";return}console.log("Dashboard page logic goes here. (Implementation pending)")}function handleDocumentsPage(){if(!localStorage.getItem("authToken")){window.location.href="login.html";return}const uploadDocumentForm=document.getElementById("upload-document-form");const documentTitleInput=document.getElementById("document-title");const documentFileInput=document.getElementById("document-file");const documentDescriptionInput=document.getElementById("document-description");const documentListDiv=document.getElementById("document-list");const uploadProgressContainer=document.getElementById("upload-progress-container");const uploadProgressBarFill=document.getElementById("upload-progress-fill");const uploadProgressText=document.getElementById("upload-progress-text");const uploadStatusText=document.getElementById("upload-status-text");const uploadButton=uploadDocumentForm?uploadDocumentForm.querySelector('button[type="submit"]'):null;async function loadDocuments(){console.log("Loading documents...");documentListDiv.innerHTML='<p style="color: var(--text-medium);">Loading documents...</p>';try{const documents=await apiRequest("GET","/documents");documentListDiv.innerHTML="";if(documents.length===0){documentListDiv.innerHTML='<p style="color: var(--text-medium);">No documents uploaded yet.</p>'}else{documents.forEach(doc=>{const docItem=document.createElement("div");docItem.className="document-item";docItem.innerHTML=`
                        <h4>${doc.title}</h4>
                        <p>File: ${doc.file_name} (${doc.mime_type||"Unknown Type"})</p>
                        <p>${doc.description||"No description provided."}</p>
                        <p style="font-size:0.8em; color:var(--text-medium);">Uploaded by: ${doc.uploaded_by||doc.uploaded_by_user_id||"N/A"} on ${new Date(doc.upload_date).toLocaleDateString()}</p>
                        <div class="actions">
                            <button class="btn-download" data-document-id="${doc.document_id}">Download</button>
                            <button class="btn-delete" data-document-id="${doc.document_id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path d="M14.5 3a1 10 0 0 1-1 1H13v9a2 10 0 0 1-2 2H5a2 10 0 0 1-2-2V4h-.5a1 10 0 0 1-1-1V2a1 10 0 0 1 1-1H6a1 10 0 0 1 1-1h2a1 10 0 0 1 1 1h3.5a1 10 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 10 0 0 0 1 1h6a1 10 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                            </button>
                        </div>
                    `;documentListDiv.appendChild(docItem)})}}catch(error){console.error("Error loading documents:",error);documentListDiv.innerHTML=`<p style="color: #e74c3c;">Error loading documents: ${error.message}</p>`}}if(uploadDocumentForm){uploadDocumentForm.addEventListener("submit",async e=>{e.preventDefault();console.log("Upload document form submitted.");const title=documentTitleInput.value.trim();const description=documentDescriptionInput.value.trim();const file=documentFileInput.files[0];if(!title||!file){showModalMessage("Document title and a file are required for upload.",true);return}if(uploadProgressContainer){uploadProgressContainer.style.display="block";uploadProgressBarFill.style.width="0%";uploadProgressText.textContent="0%";uploadStatusText.textContent="Uploading..."}if(uploadButton){uploadButton.disabled=true}const formData=new FormData;formData.append("title",title);formData.append("description",description);formData.append("document_file",file);try{console.log("Attempting to upload document via API with progress tracking.");await apiRequest("POST","/documents/upload",formData,true,event=>{if(event.lengthComputable){const percentComplete=event.loaded/event.total*100;if(uploadProgressBarFill)uploadProgressBarFill.style.width=`${percentComplete}%`;if(uploadProgressText)uploadProgressText.textContent=`${Math.round(percentComplete)}%`;if(uploadStatusText)uploadStatusText.textContent=`Uploading: ${Math.round(percentComplete)}% Complete`}});showModalMessage("Document uploaded successfully!",false);documentTitleInput.value="";documentFileInput.value="";documentDescriptionInput.value="";loadDocuments()}catch(error){console.error("Error uploading document:",error);showModalMessage(`Error uploading document: ${error.message}`,true)}finally{if(uploadProgressContainer)uploadProgressContainer.style.display="none";if(uploadButton)uploadButton.disabled=false;uploadStatusText.textContent="Upload complete (or failed)."}})}if(documentListDiv){documentListDiv.addEventListener("click",async e=>{const downloadButton=e.target.closest(".btn-download");const deleteButton=e.target.closest(".btn-delete");if(downloadButton){const documentId=downloadButton.dataset.documentId;console.log(`Download button clicked for document ID: ${documentId}`);const docInfo=await apiRequest("GET",`/documents/download/${documentId}`);if(docInfo&&docInfo.file_path){window.location.href=`${API_BASE_URL}/documents/download/${documentId}`}else{window.location.href=`${API_BASE_URL}/documents/download/${documentId}`}}else if(deleteButton){const documentId=deleteButton.dataset.documentId;console.log(`Delete button clicked for document ID: ${documentId}`);const confirmed=await showConfirmModal("Are you sure you want to delete this document? This action cannot be undone.","Delete");if(confirmed){try{console.log(`Attempting to delete document ID: ${documentId} via API.`);await apiRequest("DELETE",`/documents/${documentId}`);showModalMessage("Document deleted successfully!",false);loadDocuments()}catch(error){console.error("Error deleting document:",error);showModalMessage(`Error deleting document: ${error.message}`,true)}}}})}loadDocuments()}function handleChecklistsPage(){if(!localStorage.getItem("authToken")){window.location.href="login.html";return}console.log("Checklists page logic goes here. (Implementation pending)")}function handleNewHireViewPage(){if(!localStorage.getItem("authToken")){window.location.href="login.html";return}console.log("New Hire View page logic goes here. (Implementation pending)")}document.addEventListener("DOMContentLoaded",()=>{setupSettingsDropdown();const path=window.location.pathname;console.log("DOMContentLoaded: Current path is",path);if(path.includes("login.html")){handleLoginPage()}else if(path.includes("register.html")){handleRegisterPage()}else if(path.includes("pricing.html")){handlePricingPage()}else if(path.includes("suite-hub.html")){handleSuiteHubPage()}else if(path.includes("account.html")){handleAccountPage()}else if(path.includes("admin.html")){handleAdminPage()}else if(path.includes("scheduling.html")){handleSchedulingPage()}else if(path.includes("hiring.html")){handleHiringPage()}else if(path.includes("dashboard.html")){handleDashboardPage()}else if(path.includes("documents.html")){handleDocumentsPage()}else if(path.includes("checklists.html")){handleChecklistsPage()}else if(path.includes("new-hire-view.html")){handleNewHireViewPage()}else if(path==="/"||path==="/index.html"||path===""){console.log("Index or root page loaded.")}else{console.warn(`No specific handler found for path: ${path}`)}});