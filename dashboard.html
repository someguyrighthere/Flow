<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Flow Business Suite</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/Theme.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        .container { z-index: 2; padding: 20px 5%; box-sizing: border-box; }
        .main-nav { display: flex; gap: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 30px; }
        .main-nav a { padding: 10px 15px; text-decoration: none; color: var(--text-medium); font-weight: 600; border-bottom: 3px solid transparent; }
        .main-nav a.active { color: var(--text-light); border-bottom-color: var(--primary-accent); }
        .card {
             background-color: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);
             border: 1px solid rgba(255, 255, 255, 0.15); padding: 25px; border-radius: 8px;
        }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { font-weight: 600; margin-bottom: 5px; display: block; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 12px; border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2); background-color: rgba(0, 0, 0, 0.2);
            color: var(--text-light); box-sizing: border-box;
        }
        .form-group select option { background-color: #2a2a2e; color: #f0f0f0; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        .dashboard-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-bottom: 30px;
        }
        .dashboard-stats div {
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            min-width: 120px;
        }
        .dashboard-stats h3 {
            margin: 0;
            color: var(--primary-accent);
            font-size: 2.2rem;
        }
        .dashboard-stats p {
            margin: 5px 0 0;
            font-size: 0.9rem;
            color: var(--text-medium);
        }
        .activity-feed ul {
            list-style: none;
            padding: 0;
        }
        .activity-feed li {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        .activity-feed li strong {
            color: var(--primary-accent);
        }
        .quick-actions .btn {
            width: 100%;
            margin-bottom: 10px;
        }
        .settings-menu { position: relative; }
        .settings-dropdown {
            display: none; position: absolute; top: 55px; right: 0;
            background-color: rgba(26, 26, 26, 0.9); backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-radius: 8px;
            min-width: 180px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10; padding: 10px 0;
        }
        .settings-dropdown a, .settings-dropdown button {
            color: var(--text-light); padding: 12px 16px; text-decoration: none;
            display: block; width: 100%; text-align: left; background: none;
            border: none; font-family: 'Poppins', sans-serif; font-size: 1rem; cursor: pointer;
        }
        .settings-dropdown a:hover, .settings-dropdown button:hover { background-color: rgba(255,255,255,0.1); }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: flex; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .modal-content {
            background-color: var(--card-bg); 
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 80%; 
            max-width: 500px; 
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
            position: relative;
            color: var(--text-light);
        }
        .modal-content h3 { margin-bottom: 15px; }
        .modal-content p { margin-bottom: 20px; }
        .modal-buttons { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .modal-buttons .btn { padding: 10px 25px; font-size: 1rem; }
    </style>
</head>
<body>
    <div class="background-animation"></div>
    <div class="container">
        <header class="dashboard-header">
            <a href="suite-hub.html" style="text-decoration: none;"><h1 class="app-title">Flow Business Suite</h1></a>
            <div class="settings-menu">
                <button id="settings-button" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283-.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c-1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.858 2.929 2.929 0 0 1 0 5.858z"/></svg>
                </button>
                <div id="settings-dropdown" class="settings-dropdown">
                    <a href="account.html">My Account</a>
                    <a href="admin.html">Admin Settings</a>
                    <a href="pricing.html" id="upgrade-plan-link">Upgrade Plan</a>
                    <button id="logout-button">Logout</button>
                </div>
            </div>
        </header>
        <nav class="main-nav">
            <a href="suite-hub.html">App Hub</a>
            <a href="dashboard.html" class="active">Onboarding Dashboard</a>
            <a href="checklists.html">Task Lists</a>
        </nav>

        <section>
            <h2 style="color: var(--text-light);">Onboarding Dashboard</h2>
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Overview</h3>
                    <div class="dashboard-stats">
                        <div>
                            <h3 id="pending-onboards-count">0</h3>
                            <p>Pending Onboards</p>
                        </div>
                        <div>
                            <h3 id="in-progress-count">0</h3>
                            <p>In Progress</p>
                        </div>
                        <div>
                            <h3 id="completed-count">0</h3>
                            <p>Completed</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>Quick Actions</h3>
                    <div class="quick-actions">
                        <button id="show-onboard-modal" class="btn btn-primary">Onboard New Employee</button>
                        <button id="view-job-postings-btn" class="btn btn-secondary">View Job Postings</button>
                        <button id="view-applicants-btn" class="btn btn-secondary">View Applicants</button>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 30px;">
                <h3>Recent Activity</h3>
                <div class="activity-feed">
                    <p style="color: var(--text-medium);" id="activity-feed-placeholder">No recent activity.</p>
                    <ul id="activity-list">
                        <!-- Activity items will be loaded here -->
                    </ul>
                </div>
            </div>
        </section>
    </div>

    <!-- Modals -->
    <div id="onboard-user-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Onboard New Employee</h3>
            <form id="onboard-user-form">
                <!-- Instruction message for Admin Settings -->
                <p style="color: var(--text-light); margin-bottom: 20px;">To onboard an employee who is not yet in the system, first invite them via <a href="admin.html" style="color: var(--primary-accent); text-decoration: underline;">Admin Settings &gt; Manage Users</a>.</p>
                <hr style="border-color: var(--border-color); margin: 20px 0;">
                <p style="color: var(--text-light); margin-bottom: 15px;">Or, select an existing employee to assign their onboarding task list:</p>

                <div class="form-group">
                    <label for="existing-employee-select">Select Employee</label>
                    <select id="existing-employee-select" required>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <!-- Display the task list that will be assigned based on selected employee's position -->
                <p id="assigned-task-list-info" style="color: var(--text-medium); font-size: 0.9em; margin-top: 10px; min-height: 20px;"></p>

                <!-- Status message for onboarding form (within modal) -->
                <p id="onboard-modal-status-message" class="status-message"></p> 
                
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" id="modal-cancel-onboard">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Task List</button> <!-- Changed button text -->
                </div>
            </form>
        </div>
    </div>
    
    <!-- Message Modal Overlay (for showModalMessage function) - included here for consistency -->
    <div id="message-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <p id="modal-message-text"></p>
            <div class="modal-buttons">
                <button id="modal-close-button" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <p id="confirm-modal-message"></p>
            <div class="modal-buttons">
                <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
                <button id="modal-confirm" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module" src="js/app.js"></script>
</body>
</html>
```


```javascript
// js/pages/dashboard.js
import { apiRequest, showModalMessage, showConfirmModal } from '../utils.js';

/**
 * Handles all logic for the dashboard page.
 */
export function handleDashboardPage() {
    // Redirect to login page if no authentication token is found in local storage
    if (!localStorage.getItem("authToken")) {
        window.location.href = "login.html";
        return;
    }

    // --- DOM Elements ---
    const onboardUserModal = document.getElementById('onboard-user-modal');
    const showOnboardModalBtn = document.getElementById('show-onboard-modal');
    const modalCancelOnboardBtn = document.getElementById('modal-cancel-onboard');
    const onboardUserForm = document.getElementById('onboard-user-form');
    // NEW: Existing employee select dropdown
    const existingEmployeeSelect = document.getElementById('existing-employee-select'); 
    // NEW: Element to display assigned task list info
    const assignedTaskListInfo = document.getElementById('assigned-task-list-info');

    const onboardModalStatusMessage = document.getElementById('onboard-modal-status-message'); // For messages within the modal

    const pendingOnboardsCount = document.getElementById('pending-onboards-count');
    const inProgressCount = document.getElementById('in-progress-count');
    const completedCount = document.getElementById('completed-count');
    const activityList = document.getElementById('activity-list');
    const activityFeedPlaceholder = document.getElementById('activity-feed-placeholder');
    const viewJobPostingsBtn = document.getElementById('view-job-postings-btn');
    const viewApplicantsBtn = document.getElementById('view-applicants-btn');

    // Store all checklists and users globally once fetched to avoid re-fetching
    let allChecklists = [];
    let allUsers = [];

    // --- Helper function for local status messages (within modal) ---
    function displayStatusMessage(element, message, isError = false) {
        if (!element) return;
        element.innerHTML = message;
        element.classList.remove('success', 'error');
        element.classList.add(isError ? 'error' : 'success');
        setTimeout(() => {
            element.textContent = '';
            element.classList.remove('success', 'error');
        }, 5000);
    }

    // --- Data Loading Functions ---

    /**
     * Loads existing employees (users with role 'employee') and populates the dropdown.
     */
    async function loadExistingEmployeesForOnboard() {
        if (!existingEmployeeSelect) {
            console.error('Error: Existing employee select element (existing-employee-select) not found.');
            return;
        }
        existingEmployeeSelect.innerHTML = '<option value="">Loading employees...</option>'; 
        try {
            // Fetch all users
            const users = await apiRequest('GET', '/users');
            allUsers = users; // Store all users globally

            // Filter for employees who are not Super Admin or Location Admin
            const employeesOnly = users.filter(user => user.role === 'employee' || user.role === 'location_admin'); // Include managers who might be onboarded

            existingEmployeeSelect.innerHTML = '<option value="">Select Employee</option>'; 

            if (employeesOnly && employeesOnly.length > 0) {
                employeesOnly.forEach(emp => {
                    const option = new Option(`${emp.full_name} (${emp.email})`, emp.user_id);
                    existingEmployeeSelect.add(option);
                });
            } else {
                existingEmployeeSelect.innerHTML = '<option value="">No employees found</option>';
            }
        } catch (error) {
            console.error('Error loading existing employees for onboard modal:', error);
            existingEmployeeSelect.innerHTML = '<option value="">Error loading employees</option>';
            displayStatusMessage(onboardModalStatusMessage, `Error loading employees: ${error.message}`, true);
        }
    }

    /**
     * Fetches all checklists.
     */
    async function fetchAllChecklists() {
        try {
            const checklists = await apiRequest('GET', '/checklists');
            allChecklists = checklists; // Store all checklists globally
        } catch (error) {
            console.error('Error fetching all checklists:', error);
            // Don't display modal message here, just log, as this is a background fetch.
        }
    }

    /**
     * Displays the associated task list information when an employee is selected.
     */
    function displayAssignedTaskListInfo() {
        if (!assignedTaskListInfo || !existingEmployeeSelect || !allChecklists.length || !allUsers.length) return;

        const selectedUserId = existingEmployeeSelect.value;
        const selectedEmployee = allUsers.find(user => user.user_id == selectedUserId);

        if (selectedEmployee && selectedEmployee.position) {
            // Find a checklist that matches the employee's position
            const matchingChecklist = allChecklists.find(checklist => 
                checklist.position && checklist.position.toLowerCase() === selectedEmployee.position.toLowerCase()
            );

            if (matchingChecklist) {
                assignedTaskListInfo.textContent = `This employee will be assigned the task list: "${matchingChecklist.title}"`;
                assignedTaskListInfo.style.color = 'var(--text-light)';
            } else {
                assignedTaskListInfo.textContent = `No task list found for position: "${selectedEmployee.position}". Please create one in Admin Settings > Task Lists.`;
                assignedTaskListInfo.style.color = '#ff8a80'; // Error-like color
            }
        } else {
            assignedTaskListInfo.textContent = ''; // Clear if no employee or position selected/found
        }
    }

    /**
     * Loads and displays dashboard metrics and recent activity.
     */
    async function loadDashboardData() {
        // Placeholder for fetching actual dashboard stats
        // try {
        //     const stats = await apiRequest('GET', '/dashboard/stats');
        //     pendingOnboardsCount.textContent = stats.pending;
        //     inProgressCount.textContent = stats.inProgress;
        //     completedCount.textContent = stats.completed;
        //
        //     const activity = await apiRequest('GET', '/dashboard/activity');
        //     if (activity && activity.length > 0) {
        //         activityList.innerHTML = ''; // Clear placeholder
        //         activity.forEach(item => {
        //             const li = document.createElement('li');
        //             li.textContent = `${item.timestamp}: ${item.description}`;
        //             activityList.appendChild(li);
        //         });
        //     } else {
        //         activityFeedPlaceholder.style.display = 'block';
        //     }
        // } catch (error) {
        //     console.error('Error loading dashboard data:', error);
        //     showModalMessage('Failed to load dashboard data. Please try again.', true); // Use global modal for dashboard
        // }
    }


    // --- Event Listeners ---

    // Show onboard employee modal
    if (showOnboardModalBtn) {
        showOnboardModalBtn.addEventListener('click', () => {
            if (onboardUserModal) {
                onboardUserModal.style.display = 'flex';
                loadExistingEmployeesForOnboard(); // Load employees when modal is shown
                displayAssignedTaskListInfo(); // Update info when modal is opened (initially empty)
            }
        });
    }

    // Cancel onboard employee modal
    if (modalCancelOnboardBtn) {
        modalCancelOnboardBtn.addEventListener('click', () => {
            if (onboardUserModal) {
                onboardUserModal.style.display = 'none';
                onboardUserForm.reset(); // Clear form on cancel
                displayStatusMessage(onboardModalStatusMessage, '', false); // Clear any messages
                assignedTaskListInfo.textContent = ''; // Clear task list info
            }
        });
    }

    // Event listener for when an employee is selected in the dropdown
    if (existingEmployeeSelect) {
        existingEmployeeSelect.addEventListener('change', displayAssignedTaskListInfo);
    }


    // Submit onboard employee form (now assigns task list to existing employee)
    if (onboardUserForm) {
        onboardUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectedUserId = existingEmployeeSelect.value;
            if (!selectedUserId) {
                displayStatusMessage(onboardModalStatusMessage, 'Please select an employee.', true);
                return;
            }

            const selectedEmployee = allUsers.find(user => user.user_id == selectedUserId);
            if (!selectedEmployee) {
                displayStatusMessage(onboardModalStatusMessage, 'Selected employee not found. Please try again.', true);
                return;
            }

            // Find the task list associated with the employee's position
            const matchingChecklist = allChecklists.find(checklist => 
                checklist.position && checklist.position.toLowerCase() === selectedEmployee.position.toLowerCase()
            );

            if (!matchingChecklist) {
                displayStatusMessage(onboardModalStatusMessage, `No task list found for position: "${selectedEmployee.position}". Cannot onboard.`, true);
                return;
            }

            try {
                // NEW API call to assign a checklist to a user (onboarding_tasks table)
                // This route will need to be added to server.js
                await apiRequest('POST', '/onboarding-tasks', {
                    user_id: selectedUserId,
                    checklist_id: matchingChecklist.id
                }); 

                displayStatusMessage(onboardModalStatusMessage, `Task list "${matchingChecklist.title}" assigned to ${selectedEmployee.full_name} successfully!`, false);
                onboardUserForm.reset(); 
                assignedTaskListInfo.textContent = ''; // Clear task list info
                // Close modal after successful assignment, or keep open if they can assign multiple.
                onboardUserModal.style.display = 'none'; 
                loadDashboardData(); // Reload dashboard data 

            } catch (error) {
                displayStatusMessage(onboardModalStatusMessage, `Error assigning task list: ${error.message}`, true);
                console.error('Error assigning task list:', error);
            }
        });
    }

    // Navigation for Job Postings/Applicants - assuming these links navigate to separate pages
    if (viewJobPostingsBtn) {
        viewJobPostingsBtn.addEventListener('click', () => {
            window.location.href = 'hiring.html'; 
        });
    }

    if (viewApplicantsBtn) {
        viewApplicantsBtn.addEventListener('click', () => {
            showModalMessage('Viewing applicants functionality is not yet fully implemented.', false);
        });
    }


    // --- Initial Page Load ---
    loadDashboardData(); // Load dashboard data when the page loads
    // Fetch all checklists and users in background when dashboard loads
    fetchAllChecklists();
    loadExistingEmployeesForOnboard(); // Also load employees on initial page load if dropdown is always visible (or when modal opens)
}
